<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–æ–º–æ–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –æ—Ñ–∏—Å–∞–º</h2>

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>–ö–æ—Ä–ø—É—Å</th>
                <th>–û—Ñ–∏—Å</th>
                <th>–ö–æ–ª-–≤–æ —Å–ª–æ–º–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</th>
                <th>–î–µ—Ç–∞–ª–∏</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in stats_data %}
            <tr>
                <td>{{ stat.body_number }}</td>
                <td>{{ stat.office_number }}</td>
                <td>{{ stat.broken_count }}</td>
                <td>
                    <a href="?office_id={{ stat.office_id }}" class="btn btn-sm btn-outline-primary">
                        –ü–æ–∫–∞–∑–∞—Ç—å
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if broken_devices %}
    <div id="brokenDevicesSection" class="mt-5">
        <h4>üîß –°–ª–æ–º–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ:</h4>
        <ul class="list-group">
            {% for device in broken_devices %}
            <li class="list-group-item">
                <strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</strong> {{ device.device_serial_number }} <br>
                <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ device.reason }} <br>
                <strong>–¢–∏–ø –ø–æ–ª–æ–º–∫–∏:</strong> {{ device.breakdown_type_name }} <!-- –¢–∏–ø –ø–æ–ª–æ–º–∫–∏ -->
            </li>
            {% endfor %}
        </ul>

        <button id="hideDevicesButton" class="btn btn-outline-danger mt-3">–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
    {% endif %}

    <hr class="my-5">

    <h4 class="mb-3">üìà –ì—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª–æ–º–æ–∫</h4>
    <canvas id="barChart" width="200" height="100"></canvas>

    <hr class="my-5">
    <h4 class="mb-3">üõ†Ô∏è –¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ</h4>
    <canvas id="breakdownTypeChart" width="200" height="100"></canvas>

    <hr class="my-5">
    <h4 class="mb-3">üìÖ –ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º</h4>
    <canvas id="heatmap" width="100" height="200"></canvas>

</div>

<script>
    // –°–∫—Ä–æ–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–æ–º–æ–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫"
    document.getElementById('hideDevicesButton')?.addEventListener('click', function() {
        document.getElementById('brokenDevicesSection').classList.add('hidden');

        // –£–¥–∞–ª–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä office_id –∏–∑ URL
        const url = new URL(window.location.href);
        url.searchParams.delete('office_id');
        window.history.replaceState({}, '', url);
    });

    const breakdownTypeData = {{ breakdown_type_data|safe }};
    const breakdownLabels = breakdownTypeData.map(item => item.type);
    const breakdownCounts = breakdownTypeData.map(item => item.count);

    const breakdownTypeChart = new Chart(document.getElementById('breakdownTypeChart'), {
        type: 'pie',
        data: {
            labels: breakdownLabels,
            datasets: [{
                label: '–¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫',
                data: breakdownCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ'
                }
            }
        }
    });

    const heatmapData = {{ heatmap_data|safe }};
    const parsedData = {};
    heatmapData.forEach(entry => {
        const date = new Date(entry.date);
        const timestamp = Math.floor(date.getTime() / 1000);
        parsedData[timestamp] = entry.count;
    });

    const heatmapChart = new Chart(document.getElementById('heatmap'), {
        type: 'line',
        data: {
            labels: Object.keys(parsedData).map(timestamp => new Date(timestamp * 1000).toLocaleDateString()),
            datasets: [{
                label: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º',
                data: Object.values(parsedData),
                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º'
                }
            }
        }
    });

    const chartData = {{ chart_data|safe }};
    const labels = chartData.map(e => "–û—Ñ–∏—Å " + e.office_number);
    const data = chartData.map(e => e.broken_count);

    new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–°–ª–æ–º–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                data: data,
                backgroundColor: 'rgba(255, 99, 132, 0.5)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –æ—Ñ–∏—Å–∞–º'
                }
            }
        }
    });
</script>
</body>
</html>
