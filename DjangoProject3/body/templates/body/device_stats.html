<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–æ–º–æ–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .hidden {
            display: none;
        }

        canvas {
        max-width: 100%;  /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        width: 100%;      /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É –Ω–∞ 100% */
        height: auto;     /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
        max-height: 400px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç—ã */
    }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –æ—Ñ–∏—Å–∞–º</h2>

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>–ö–æ—Ä–ø—É—Å</th>
                <th>–ö–∞–±–∏–Ω–µ—Ç</th>
                <th>–ö–æ–ª-–≤–æ —Å–ª–æ–º–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</th>
                <th>–î–µ—Ç–∞–ª–∏</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in stats_data %}
            <tr>
                <td>{{ stat.body_number }}</td>
                <td>{{ stat.office_number }}</td>
                <td>{{ stat.broken_count }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-show-devices" data-office-id="{{ stat.office_id }}">
    –ü–æ–∫–∞–∑–∞—Ç—å
</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="brokenDevicesSection" class="mt-5 hidden">
    <h4>üîß –°–ª–æ–º–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ:</h4>
    <ul class="list-group" id="brokenDeviceList">

    </ul>

    <hr class="my-5">
    <h4 class="mb-3">üõ†Ô∏è –¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ</h4>
    <canvas id="breakdownTypeChart" width="50" height="50"></canvas>

    <button id="hideDevicesButton" class="btn btn-outline-danger mt-3">–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫</button>
</div>

    <h4 class="mb-3">üìà –ì—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª–æ–º–æ–∫</h4>
    <canvas id="barChart" width="100" height="50"></canvas>


    <hr class="my-5">
    <h4 class="mb-3">üìÖ –ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º</h4>
    <canvas id="heatmap" width="100" height="50"></canvas>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.btn-show-devices').forEach(button => {
        button.addEventListener('click', function () {
            const officeId = this.getAttribute('data-office-id');

            fetch("{% url 'device_breakdown_stats' %}?office_id=" + officeId, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(data => {
                renderBrokenDevices(data.broken_devices);
                renderBreakdownTypeChart(data.breakdown_type_data);
            });
        });
    });

    function renderBrokenDevices(devices) {
        const section = document.getElementById("brokenDevicesSection");
        if (!section) {
            console.warn("‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç #brokenDevicesSection –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }

        section.classList.remove("hidden");

        const list = section.querySelector("ul");
        if (!list) {
            console.warn("‚ö†Ô∏è ul –≤–Ω—É—Ç—Ä–∏ #brokenDevicesSection –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }

        list.innerHTML = '';

        devices.forEach(device => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `
                <strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</strong> ${device.device_serial_number} <br>
                <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${device.reason} <br>
                <strong>–¢–∏–ø –ø–æ–ª–æ–º–∫–∏:</strong> ${device.breakdown_type_name}
            `;
            list.appendChild(li);
        });
    }

    let breakdownTypeChartInstance = null; // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞

function renderBreakdownTypeChart(data) {
    const labels = data.map(item => item.type);
    const counts = data.map(item => item.count);

    // –£–Ω–∏—á—Ç–æ–∂–∏–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–∏–∞–≥—Ä–∞–º–º—É, –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (breakdownTypeChartInstance) {
        breakdownTypeChartInstance.destroy();
    }

    const ctx = document.getElementById('breakdownTypeChart').getContext('2d');

    breakdownTypeChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: '–¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫',
                data: counts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–¢–∏–ø—ã –ø–æ–ª–æ–º–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ—Ñ–∏—Å–µ'
                }
            }
        }
    });
}

});

    // –°–∫—Ä–æ–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–æ–º–æ–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫"
    document.getElementById('hideDevicesButton')?.addEventListener('click', function() {
        document.getElementById('brokenDevicesSection').classList.add('hidden');

        // –£–¥–∞–ª–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä office_id –∏–∑ URL
        const url = new URL(window.location.href);
        url.searchParams.delete('office_id');
        window.history.replaceState({}, '', url);
    });

    const breakdownTypeData = {{ breakdown_type_data|safe }};
    const breakdownLabels = breakdownTypeData.map(item => item.type);
    const breakdownCounts = breakdownTypeData.map(item => item.count);


    const heatmapData = {{ heatmap_data|safe }};
    const parsedData = {};
    heatmapData.forEach(entry => {
        const date = new Date(entry.date);
        const timestamp = Math.floor(date.getTime() / 1000);
        parsedData[timestamp] = entry.count;
    });

    const heatmapChart = new Chart(document.getElementById('heatmap'), {
        type: 'line',
        data: {
            labels: Object.keys(parsedData).map(timestamp => new Date(timestamp * 1000).toLocaleDateString()),
            datasets: [{
                label: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º',
                data: Object.values(parsedData),
                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –¥–Ω—è–º'
                }
            }
        }
    });

    const chartData = {{ chart_data|safe }};
    const labels = chartData.map(e => "–û—Ñ–∏—Å " + e.office_number);
    const data = chartData.map(e => e.broken_count);

    new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–°–ª–æ–º–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                data: data,
                backgroundColor: 'rgba(255, 99, 132, 0.5)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: '–ü–æ–ª–æ–º–∫–∏ –ø–æ –æ—Ñ–∏—Å–∞–º'
                }
            }
        }
    });


function updatePieChart(newData) {
    const labels = newData.map(item => item.type);
    const values = newData.map(item => item.count);

    breakdownTypeChart.data.labels = labels;
    breakdownTypeChart.data.datasets[0].data = values;
    breakdownTypeChart.update();
}
</script>

</body>
</html>
