<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h2, h3 {
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .link-container {
            margin-top: 20px;
            text-align: center;
        }
        .link-container a {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .link-container a:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div class="notification-container">
    <span class="bell">üîî</span>
    <span class="count">{{ notifications_count }}</span>
</div>

<div class="link-container">
    <a href="{% url 'password_change' %}">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
    <form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button type="submit">–í—ã–π—Ç–∏</button>
</form>

</div>

    <div class="container">
        <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</p>

        <h3>–í–∞—à–∏ –∑–∞—è–≤–∫–∏</h3>
        <div class="table-container">
            <table>
    <thead>
        <tr>
            <th>ID</th>
            <th>–û—Ñ–∏—Å</th>
            <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
            <th>–¢–∏–ø –ø–æ–ª–æ–º–∫–∏</th>
            <th>–î–∞—Ç–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th> <!-- –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü -->
        </tr>
    </thead>
    <tbody>
        {% for application in applications %}
            <tr>
                <td>{{ application.id }}</td>
                <td>{{ application.office_number }}</td>
                <td>{{ application.device_serial_number }}</td>
                <td>{{ application.reason }}</td>
                <td>{{ application.breakdown_type_name }}</td>
                <td>{{ application.data }}</td>
                <td>{{ application.status_name }}</td>
                <td>
                    <button class="delete-btn" data-id="{{ application.id }}">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="8">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

        </div>

    </div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                let applicationId = this.dataset.id;
                let row = this.closest("tr"); // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å

                if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?")) {
                    fetch(`/body/delete_application/${applicationId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert("–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞!");
                            row.remove(); // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

                            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                            updateNotificationCount();
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏!");
                        }
                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞:", error);
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É.");
                    });
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateNotificationCount() {
        let countElement = document.querySelector(".count");

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let currentCount = parseInt(countElement.textContent);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, —É–º–µ–Ω—å—à–∞—è –Ω–∞ 1
        if (currentCount > 0) {
            countElement.textContent = currentCount - 1;
        }
    }
</script>



</body>
</html>
