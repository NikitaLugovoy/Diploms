<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –ø–æ–ª–æ–º–∞–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --bg-light: #f8f9fa;
            --bg-dark: #212529;
            --text-light: #343a40;
            --text-dark: #e9ecef;
            --accent: #007bff;
            --broken-bg-dark: #7b2d2d;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* –ò–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ navbar –∏ footer */
            transition: all 0.4s ease;
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        #preloader {
            background: var(--bg-light);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.dark-mode #preloader {
            background: var(--bg-dark);
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #dee2e6;
            border-top: 8px solid var(--accent);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–±–∞—Ä–∞ */
        .navbar {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #dee2e6, -8px -8px 16px #ffffff;
            transition: all 0.4s ease;
            margin: 10px auto;
            max-width: 1250px;
            padding: 0.5rem 1rem;
            z-index: 1000;
        }

        body.dark-mode .navbar {
            background: #343a40;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-light);
        }

        body.dark-mode .navbar-brand {
            color: var(--text-dark);
        }

        .navbar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .navbar-nav .nav-link {
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
        }

        body.dark-mode .navbar-nav .nav-link {
            color: var(--text-dark);
        }

        .navbar-nav .nav-link:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--accent);
        }

        body.dark-mode .navbar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .navbar-nav .nav-link.active {
            background-color: var(--accent);
            color: #ffffff !important;
        }

        .navbar-nav .nav-link i {
            margin-right: 0.5rem;
        }

        .theme-toggle {
            background-color: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .theme-toggle:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        body.dark-mode .theme-toggle {
            background-color: #0056b3;
        }

        .navbar-toggler {
            border-color: var(--accent);
        }

        body.dark-mode .navbar-toggler {
            border-color: #495057;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(0, 123, 255, 1)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        body.dark-mode .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.8)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #dee2e6, -8px -8px 16px #ffffff;
            max-width: 90%;
            width: 100%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.4s ease;
            margin-top: 80px; /* –£—á–µ—Ç –≤—ã—Å–æ—Ç—ã navbar */
            margin-bottom: 20px; /* –î–ª—è footer */
        }

        body.dark-mode .form-container {
            background-color: #343a40;
            box-shadow: none;
        }

        h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 20px;
        }

        h3 {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 15px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        form label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
            display: block;
            text-align: left;
        }

        body.dark-mode form label {
            color: var(--text-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #495057;
            border-color: #6c757d;
            color: var(--text-dark);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        button, .btn {
            background-color: var(--accent);
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
        }

        button:hover, .btn:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .content-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        .body-list, .floors-list, .offices-list, .devices-list {
            flex: 1 1 calc(33.33% - 20px);
            box-sizing: border-box;
        }

        .devices-list {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
            padding: 20px;
            min-height: 300px;
            width: 100%;
            overflow-x: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        }

        .devices-grid::-webkit-scrollbar {
            height: 8px; /* –í—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        }

        .devices-grid::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 4px;
        }

        .devices-grid::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        body.dark-mode .devices-grid::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .devices-grid {
            display: grid;
            gap: 10px;
            justify-content: center;
            align-content: center;
            margin: auto;
            max-width: 100%;
            padding: 15px;
            background-color: #f1f3f5;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        body.dark-mode .devices-grid {
            background-color: #2c3034;
            border-color: #6c757d;
        }

        .device-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: #ffffff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
            min-width: 100px;
            min-height: 100px;
            margin: 5px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .device-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .device-item {
            background-color: #495057;
            border-color: #6c757d;
            color: var(--text-dark);
        }

        .device-item.broken {
            border: 3px solid #dc3545;
            background-color: #fff0f0;
            position: relative;
        }

        .device-item.broken::after {
            content: '\f071';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: -12px;
            right: -12px;
            font-size: 18px;
            color: #dc3545;
            background-color: #ffffff;
            border-radius: 50%;
            padding: 4px;
        }

        body.dark-mode .device-item.broken {
            background-color: var(--broken-bg-dark);
            border-color: #ff4d4d;
        }

        body.dark-mode .device-item.broken::after {
            background-color: #343a40;
            color: #ff4d4d;
        }

        .device-item.selected {
            border: 3px solid var(--accent);
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.5);
            background-color: #e9f2ff;
        }

        body.dark-mode .device-item.selected {
            background-color: #5a6268;
            border-color: #80bdff;
        }

        .device-image {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .device-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            line-height: 1.2;
            max-width: 100%;
            word-wrap: break-word;
        }

        body.dark-mode .device-label {
            color: var(--text-dark);
        }

        .status-message {
            color: #dc3545;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
        }

        .form-check-input {
            display: none;
        }

        .form-check {
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .form-check.selected {
            border: 2px solid var(--accent);
            background-color: #e9f2ff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        body.dark-mode .form-check.selected {
            background-color: #5a6268;
            border-color: #80bdff;
        }

        .broken-device {
            border: 3px solid #dc3545;
            background-color: #fff0f0;
            position: relative;
        }

        body.dark-mode .broken-device {
            background-color: var(--broken-bg-dark);
            border-color: #ff4d4d;
        }

        .broken-device::after {
            content: '\f071';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: -12px;
            right: -12px;
            font-size: 18px;
            color: #dc3545;
            background-color: #ffffff;
            border-radius: 50%;
            padding: 4px;
        }

        body.dark-mode .broken-device::after {
            background-color: #343a40;
            color: #ff4d4d;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            transition: all 0.4s ease;
        }

        body.dark-mode .modal-content {
            background-color: #343a40;
        }

        .modal-title {
            color: var(--accent);
            font-weight: 700;
        }

        .modal-body, .modal-footer {
            padding: 20px;
        }

        .btn-back {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        footer {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: #6c757d;
            margin-top: auto;
        }

        body.dark-mode footer {
            color: #adb5bd;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 28px;
            }

            .form-container {
                padding: 20px;
                margin-top: 70px; /* –£—á–µ—Ç –≤—ã—Å–æ—Ç—ã navbar –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }

            .content-container {
                flex-direction: column;
            }

            .body-list, .floors-list, .offices-list, .devices-list {
                flex: 1 1 100%;
            }

            .devices-list {
                position: relative;
                z-index: 10; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—à–µ, —á–µ–º —É .form-container */
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                padding: 10px;
                min-height: 100px; /* –£–º–µ–Ω—å—à–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
                width: 100%;
                overflow-x: auto; /* –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            }

            .devices-grid {
                display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –≤–º–µ—Å—Ç–æ grid */
                flex-direction: row; /* –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é */
                gap: 8px;
                padding: 10px;
                width: auto; /* –®–∏—Ä–∏–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º—ã–º */
                min-width: fit-content; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
                overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
                white-space: nowrap; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
                background-color: #f1f3f5;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            body.dark-mode .devices-grid {
                background-color: #2c3034;
                border-color: #6c757d;
            }

            .device-item {
                min-width: 70px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ */
                min-height: 70px;
                padding: 8px;
                flex: 0 0 auto; /* –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è */
            }

            .device-image {
                width: 25px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
                height: 25px;
            }

            .device-label {
                font-size: 9px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            .devices-grid::-webkit-scrollbar {
                height: 8px; /* –í—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            }

            .devices-grid::-webkit-scrollbar-thumb {
                background-color: var(--accent);
                border-radius: 4px;
            }

            .devices-grid::-webkit-scrollbar-track {
                background: var(--bg-light);
            }

            body.dark-mode .devices-grid::-webkit-scrollbar-track {
                background: var(--bg-dark);
            }

            .notification-link {
                position: relative;
                display: flex;
                align-items: center;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                transition: background-color 0.3s ease, color 0.3s ease;
            }

            .notification-link .notification-count {
                background-color: var(--accent);
                color: #ffffff;
                font-size: 0.75rem;
                font-weight: 600;
                padding: 2px 8px;
                border-radius: 12px;
                margin-left: 0.5rem;
                min-width: 20px;
                text-align: center;
            }

            body.dark-mode .notification-link .notification-count {
                background-color: #0056b3;
            }

            .notification-link:hover {
                background-color: rgba(0, 123, 255, 0.1);
                color: var(--accent);
            }

            body.dark-mode .notification-link:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }

            @media (max-width: 992px) {
                .notification-link {
                    padding: 0.5rem 0.75rem;
                }

                .notification-link .notification-count {
                    font-size: 0.7rem;
                    padding: 2px 6px;
                    min-width: 18px;
                }
            }

            @media (max-width: 768px) {
                .notification-link .notification-count {
                    font-size: 0.65rem;
                    padding: 1px 5px;
                    min-width: 16px;
                }
            }
        }
    </style>
</head>
<body>
<!-- Preloader -->
<div id="preloader">
    <div class="spinner"></div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNavbar">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-tools me-2"></i>–°–µ—Ä–≤–∏—Å
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                {% if role == "admin" %}
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'body_list' %}">
                            <i class="fas fa-tools me-1"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'fastapplication_list' %}">
                            <i class="fas fa-bolt me-1"></i> –ë—ã—Å—Ç—Ä–∞—è –∑–∞—è–≤–∫–∞
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ya_page' %}">
                            <i class="fas fa-robot me-1"></i> YandexGPT
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'device_breakdown_stats' %}">
                            <i class="fas fa-chart-bar me-1"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/">
                            <i class="fas fa-cogs me-1"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lkuser' %}">
                            <i class="fas fa-user-circle me-1"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                        </a>
                    </li>
                {% elif role == "teacher" %}
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'body_list' %}">
                            <i class="fas fa-tools me-1"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'fastapplication_list' %}">
                            <i class="fas fa-bolt me-1"></i> –ë—ã—Å—Ç—Ä–∞—è –∑–∞—è–≤–∫–∞
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ya_page' %}">
                            <i class="fas fa-robot me-1"></i> YandexGPT
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lkuser' %}">
                            <i class="fas fa-user-circle me-1"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                        </a>
                    </li>
                {% elif role == "master" %}
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'body_list' %}">
                            <i class="fas fa-tools me-1"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'application_list' %}">
                            <i class="fas fa-file-alt me-1"></i> –ó–∞—è–≤–∫–∏
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lkuser' %}">
                            <i class="fas fa-user-circle me-1"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                        </a>
                    </li>
                {% endif %}
                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                <li class="nav-item">
                    <a class="nav-link notification-link" href="#">
                        <i class="fas fa-bell me-1"></i>
                        {% if notifications_count > 0 %}
                            <span class="notification-count">{{ notifications_count }}</span>
                        {% else %}
                            <span class="notification-count" style="display: none;">0</span>
                        {% endif %}
                    </a>
                </li>
                <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã -->
                <li class="nav-item">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon me-1"></i> –¢–µ–º–∞
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="main-content">
    <div class="form-container">
        <h1 class="text-center">–í—ã–±–æ—Ä –ø–æ–ª–æ–º–∞–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h1>

        <form method="POST" id="selectionForm">
            {% csrf_token %}
            <div class="content-container">
                <div class="body-list">
                    <h3>–°–ø–∏—Å–æ–∫ –ö–æ—Ä–ø—É—Å–æ–≤</h3>
                    {% for body in bodies %}
                        <div class="form-check">
                            <input
                                    class="form-check-input"
                                    type="radio"
                                    name="selected_bodies"
                                    value="{{ body.id }}"
                                    id="body_{{ body.id }}"
                                    {% if body.id|stringformat:"s" in selected_bodies %}checked{% endif %}
                            >
                            <label class="form-check-label" for="body_{{ body.id }}">
                                <strong>{{ body.number }}</strong> ‚Äî {{ body.address }}
                            </label>
                        </div>
                    {% endfor %}
                </div>

                <div class="floors-list" id="floors-list" style="display: none;">
                    <h3>–°–ø–∏—Å–æ–∫ —ç—Ç–∞–∂–µ–π</h3>
                    <div id="floors-list-content"></div>
                </div>

                <div class="offices-list" id="offices-list" style="display: none;">
                    <h3>–°–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤</h3>
                    <div id="offices-list-content"></div>
                </div>

                <div class="devices-list" style="display: none;">
                    <h3>–°—Ö–µ–º–∞ –∫–∞–±–∏–Ω–µ—Ç–∞</h3>
                    <div id="devices-list" class="devices-grid"></div>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deviceModalLabel">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="filtered-devices-list text-center">
                                <h3>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
                                <div id="modal-filtered-devices-list-content"></div>
                                <div id="modal-messageForm">
                                    <div class="form-group">
                                        <label for="modalBreakdownType">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª–æ–º–∫–∏:</label>
                                        <select class="form-control" id="modalBreakdownType">
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                                        </select>
                                    </div>
                                    <h4>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</h4>
                                    <textarea class="form-control" rows="4" id="modalMessage"
                                              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
                                    <button type="button" class="btn btn-primary mt-3" id="modalSendMessage">
                                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<footer>¬© 2025 –í–∞—à –°–µ—Ä–≤–∏—Å. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DOMCache = {
        preloader: document.getElementById('preloader'),
        body: document.body,
        themeToggle: document.querySelector('.theme-toggle'),
        floorsList: document.getElementById('floors-list'),
        floorsListContent: document.getElementById('floors-list-content'),
        officesList: document.getElementById('offices-list'),
        officesListContent: document.getElementById('offices-list-content'),
        devicesList: document.getElementById('devices-list'),
        modalFilteredDevicesListContent: document.getElementById('modal-filtered-devices-list-content'),
        modalBreakdownType: document.getElementById('modalBreakdownType'),
        modalMessage: document.getElementById('modalMessage'),
        modalSendMessage: document.getElementById('modalSendMessage'),
        devicesListContainer: document.querySelector('.devices-list'),
        notificationCount: document.querySelector('.notification-count')
    };

    window.userRole = "{{ role|escapejs }}";

    window.addEventListener('load', () => {
        DOMCache.preloader.style.display = 'none';
    });

    function toggleTheme() {
        const isDark = DOMCache.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        DOMCache.themeToggle.textContent = isDark ? '‚òÄÔ∏è –¢–µ–º–∞' : 'üåô –¢–µ–º–∞';
    }

    // Load theme from localStorage
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('theme') === 'dark') {
            DOMCache.body.classList.add('dark-mode');
            DOMCache.themeToggle.textContent = '‚òÄÔ∏è –¢–µ–º–∞';
        } else {
            DOMCache.themeToggle.textContent = 'üåô –¢–µ–º–∞';
        }
    });

    function getCSRFToken() {
        let token = null;
        document.cookie.split(';').forEach(function (cookie) {
            if (cookie.trim().startsWith('csrftoken=')) {
                token = cookie.split('=')[1];
            }
        });
        return token;
    }

    function updateFloorsList(floors, selectedFloors) {
        const previouslySelectedFloors = new Set(
            Array.from(document.querySelectorAll('input[name="selected_floors"]:checked'))
                .map(radio => radio.value)
        );
        DOMCache.floorsListContent.innerHTML = "";
        if (floors && floors.length > 0) {
            floors.forEach(floor => {
                const floorElement = document.createElement('div');
                floorElement.classList.add('form-check');
                const isChecked = previouslySelectedFloors.has(floor.id.toString());
                floorElement.innerHTML = `
                <input class="form-check-input" type="radio" name="selected_floors" value="${floor.id}" id="floor_${floor.id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="floor_${floor.id}">
                    –≠—Ç–∞–∂ ‚Ññ${floor.number}
                </label>
            `;
                if (isChecked) {
                    floorElement.classList.add('selected');
                }
                DOMCache.floorsListContent.appendChild(floorElement);
            });
            DOMCache.floorsList.style.display = 'block';
        } else {
            DOMCache.floorsList.style.display = 'none';
        }
    }

    // Event handler for input changes
    function handleInputChange(event) {
        if (event.target.classList.contains('form-check-input')) {
            const groupName = event.target.name;
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(input => {
                input.closest('.form-check').classList.remove('selected');
            });
            if (event.target.checked) {
                event.target.closest('.form-check').classList.add('selected');
            }

            // Reset subsequent selections when body or floor changes
            if (event.target.name === 'selected_bodies') {
                document.querySelectorAll('input[name="selected_floors"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.form-check')?.classList.remove('selected');
                });
                document.querySelectorAll('input[name="selected_offices"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.form-check')?.classList.remove('selected');
                });
                document.querySelectorAll('input[name="selected_package_devices"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.device-item')?.classList.remove('selected');
                });
                DOMCache.floorsListContent.innerHTML = "";
                DOMCache.officesListContent.innerHTML = "";
                DOMCache.devicesList.innerHTML = "";
                DOMCache.officesList.style.display = 'none';
                DOMCache.devicesListContainer.style.display = 'none';
            } else if (event.target.name === 'selected_floors') {
                document.querySelectorAll('input[name="selected_offices"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.form-check')?.classList.remove('selected');
                });
                document.querySelectorAll('input[name="selected_package_devices"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.device-item')?.classList.remove('selected');
                });
                DOMCache.officesListContent.innerHTML = "";
                DOMCache.devicesList.innerHTML = "";
                DOMCache.officesList.style.display = 'none';
                DOMCache.devicesListContainer.style.display = 'none';
            }
        }

        if (event.target.name === 'selected_filtered_devices') {
            const selectedDeviceId = event.target.value;
            const isChecked = event.target.checked;
            console.log(isChecked ? `–í—ã–±—Ä–∞–Ω ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${selectedDeviceId}` : `–°–Ω—è—Ç–∞ –≥–∞–ª–æ—á–∫–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ID: ${selectedDeviceId}`);
        }

        fetchOfficesAndDevices();
    }

    // Fetch offices and devices
    function fetchOfficesAndDevices() {
        const selectedBodies = document.querySelectorAll('input[name="selected_bodies"]:checked');
        const selectedFloors = document.querySelectorAll('input[name="selected_floors"]:checked');
        const selectedOffices = document.querySelectorAll('input[name="selected_offices"]:checked');
        const selectedDevices = document.querySelectorAll('input[name="selected_package_devices"]:checked');
        const selectedFilteredDevices = document.querySelectorAll('input[name="selected_filtered_devices"]:checked');

        const formData = new FormData();
        selectedBodies.forEach(checkbox => formData.append('selected_bodies', checkbox.value));
        selectedFloors.forEach(checkbox => formData.append('selected_floors', checkbox.value));
        selectedOffices.forEach(checkbox => formData.append('selected_offices', checkbox.value));
        selectedDevices.forEach(radio => formData.append('selected_package_devices', radio.value));
        selectedFilteredDevices.forEach(checkbox => formData.append('selected_filtered_devices', checkbox.value));

        // Manage block visibility
        DOMCache.floorsList.style.display = selectedBodies.length > 0 ? 'block' : 'none';
        DOMCache.officesList.style.display = (selectedBodies.length > 0 && selectedFloors.length > 0) ? 'block' : 'none';
        DOMCache.devicesListContainer.style.display = selectedOffices.length > 0 ? 'block' : 'none';

        fetch('/body/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                updateFloorsList(data.floors, selectedFloors);
                updateOfficesList(data.offices, selectedOffices);
                updatePackageDevicesList(data.package_devices, selectedDevices, data.layouts[0] || null);
                updateDevicesList(data.devices, selectedFilteredDevices);
                updateBreakdownTypeSelect(data.breakdown_types);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
            });
    }

    function updateOfficesList(offices, selectedOffices) {
        const previouslySelectedOffices = new Set(
            Array.from(document.querySelectorAll('input[name="selected_offices"]:checked'))
                .map(radio => radio.value)
        );
        DOMCache.officesListContent.innerHTML = "";
        if (offices && offices.length > 0) {
            offices.forEach(office => {
                const officeElement = document.createElement('div');
                officeElement.classList.add('form-check');
                const isChecked = previouslySelectedOffices.has(office.id.toString());
                officeElement.innerHTML = `
                <input class="form-check-input" type="radio" name="selected_offices" value="${office.id}" id="office_${office.id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="office_${office.id}">
                    –ö–∞–±–∏–Ω–µ—Ç ${office.number}
                </label>
            `;
                DOMCache.officesListContent.appendChild(officeElement);
            });
        }
        DOMCache.officesListContent.style.display = 'block';
    }

    function updateBreakdownTypeSelect(breakdownTypes) {
        const previouslySelectedValue = DOMCache.modalBreakdownType.value;
        DOMCache.modalBreakdownType.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
        if (breakdownTypes && breakdownTypes.length > 0) {
            breakdownTypes.forEach(type => {
                const option = document.createElement("option");
                option.value = type.id;
                option.textContent = type.name;
                if (option.value === previouslySelectedValue) {
                    option.selected = true;
                }
                DOMCache.modalBreakdownType.appendChild(option);
            });
        }
    }

    function updatePackageDevicesList(devices, selectedDevices, layout) {
        console.log("userRole:", window.userRole);
        console.log("devices:", devices);
        console.log("layout:", layout);

        if (!DOMCache.devicesList) {
            console.error("–≠–ª–µ–º–µ–Ω—Ç #devices-list –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
            return;
        }
        DOMCache.devicesList.innerHTML = "";

        if (!layout || !layout.width || !layout.height || !layout.device_positions) {
            DOMCache.devicesList.innerHTML = "<p>–°—Ö–µ–º–∞ –∫–∞–±–∏–Ω–µ—Ç–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞.</p>";
            console.log("–°—Ö–µ–º–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞");
            return;
        }

        const grid = document.createElement("div");
        grid.classList.add("devices-grid");
        grid.style.minWidth = `${layout.width * 80}px`;

        layout.device_positions.forEach(position => {
            console.log("position:", position);
            if (position.is_active && position.x >= 0 && position.y >= 0) {
                const device = devices.find(d => d.id === position.package_device_id);
                console.log("found device:", device);
                if (device) {
                    const deviceItem = document.createElement("div");
                    deviceItem.classList.add("device-item");
                    deviceItem.style.gridRow = `${position.y + 1}`;
                    deviceItem.style.gridColumn = `${position.x + 1}`;

                    let deviceImage = `
                    <img src="https://avatars.mds.yandex.net/i?id=de9bb9dab04e704fd1c23bce4ff5b4b1e408d419-5475958-images-thumbs&n=13" alt="Device Image" class="device-image">
                `;
                    if (Number(device.condition_id) === 4) {
                        deviceItem.classList.add("broken");
                    }

                    const imageContainer = document.createElement("div");
                    imageContainer.classList.add("device-image-container");
                    imageContainer.innerHTML = deviceImage;

                    let serialNumberDisplay = "";
                    if (window.userRole === "master") {
                        serialNumberDisplay = `<div class="device-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${device.number}</div>`;
                    } else if (window.userRole === "admin" || window.userRole === "teacher") {
                        serialNumberDisplay = "";
                    } else {
                        console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å:", window.userRole);
                        serialNumberDisplay = "";
                    }

                    deviceItem.innerHTML += `
                    <input type="radio" name="selected_package_devices" value="${device.id}" id="device_${device.id}" style="display: none;">
                    ${serialNumberDisplay}
                `;

                    deviceItem.appendChild(imageContainer);
                    grid.appendChild(deviceItem);

                    deviceItem.addEventListener("click", function () {
                        const radio = deviceItem.querySelector(`input[type="radio"]`);
                        radio.checked = true;
                        radio.dispatchEvent(new Event("change", {bubbles: true}));

                        if (!DOMCache.modalFilteredDevicesListContent) {
                            console.error("–≠–ª–µ–º–µ–Ω—Ç #modal-filtered-devices-list-content –Ω–µ –Ω–∞–π–¥–µ–Ω");
                            return;
                        }

                        let modalSerialNumber = "";
                        if (window.userRole === "master") {
                            modalSerialNumber = `, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${device.serial_number}`;
                        }

                        DOMCache.modalFilteredDevicesListContent.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="selected_filtered_devices" value="${device.id}" id="modal_filtered_device_${device.id}" checked>
                            <label class="form-check-label" for="modal_filtered_device_${device.id}">
                                –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${device.type_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}${modalSerialNumber}
                            </label>
                        </div>
                    `;

                        DOMCache.modalMessage.value = "";

                        const modal = new bootstrap.Modal(document.getElementById("deviceModal"));
                        modal.show();
                    });
                }
            }
        });

        DOMCache.devicesList.appendChild(grid);

        selectedDevices.forEach(checkbox => {
            const selectedCheckbox = document.getElementById(`device_${checkbox.value}`);
            if (selectedCheckbox) {
                selectedCheckbox.checked = true;
            }
        });
    }

    function updateDevicesList(devices, selectedDevices) {
        const previouslySelectedDeviceIds = Array.from(
            document.querySelectorAll('input[name="selected_filtered_devices"]:checked')
        ).map(radio => radio.value);
        DOMCache.modalFilteredDevicesListContent.innerHTML = "";

        if (devices && devices.length > 0) {
            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.classList.add('form-check');
                if (device.condition_id === 4) {
                    deviceItem.classList.add('broken-device');
                }
                const isChecked = previouslySelectedDeviceIds.includes(device.id.toString());

                let serialNumberDisplay = "";
                if (window.userRole === "master") {
                    serialNumberDisplay = `, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${device.serial_number}`;
                } else if (window.userRole === "admin" || window.userRole === "teacher") {
                    serialNumberDisplay = "";
                } else {
                    console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å:", window.userRole);
                    serialNumberDisplay = "";
                }

                deviceItem.innerHTML = `
                <input class="form-check-input" type="checkbox" name="selected_filtered_devices" value="${device.id}" id="modal_filtered_device_${device.id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="modal_filtered_device_${device.id}">
                    –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${device.type_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}${serialNumberDisplay}
                </label>
            `;
                DOMCache.modalFilteredDevicesListContent.appendChild(deviceItem);

                const checkbox = deviceItem.querySelector('input[type="checkbox"]');

                if (isChecked) {
                    deviceItem.classList.add('selected');
                }
                if (device.condition_id === 4) {
                    checkbox.disabled = true;
                }

                checkbox.addEventListener('change', function () {
                    if (checkbox.checked) {
                        deviceItem.classList.add('selected');
                    } else {
                        deviceItem.classList.remove('selected');
                    }
                });

                deviceItem.addEventListener('click', function () {
                    if (!checkbox.disabled) {
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            deviceItem.classList.add('selected');
                        } else {
                            deviceItem.classList.remove('selected');
                        }
                    }
                });
            });
        }
    }

    const observer = new MutationObserver(() => {
        const checkedOffice = document.querySelector('input[name="selected_offices"]:checked');
        if (checkedOffice) {
            checkedOffice.closest('.form-check').classList.add('selected');
        }
    });

    observer.observe(DOMCache.officesListContent, {
        childList: true,
        subtree: true
    });

    document.addEventListener('change', handleInputChange);

    DOMCache.modalSendMessage.addEventListener('click', function () {
        const message = DOMCache.modalMessage.value.trim();
        const selectedFilteredDevices = document.querySelectorAll('input[name="selected_filtered_devices"]:checked');
        const breakdownType = DOMCache.modalBreakdownType.value;

        if (!message) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!");
            return;
        }

        if (selectedFilteredDevices.length === 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!");
            return;
        }

        if (!breakdownType) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª–æ–º–∫–∏!");
            return;
        }

        const data = {
            message: message,
            breakdown_type: parseInt(breakdownType),
            selected_filtered_devices: Array.from(selectedFilteredDevices).map(cb => parseInt(cb.value))
        };

        fetch('send-message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                    resetCheckboxes();
                    DOMCache.modalMessage.value = '';
                    DOMCache.modalBreakdownType.value = '';
                    selectedFilteredDevices.forEach(radio => radio.checked = false);
                    bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            });
    });

    function resetCheckboxes() {

        document.querySelectorAll('input[name="selected_package_devices"]').forEach(radio => {
            radio.checked = false;
            radio.closest('.device-item')?.classList.remove('selected');
        });
        document.querySelectorAll('input[name="selected_filtered_devices"]').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.form-check')?.classList.remove('selected');
        });

        DOMCache.devicesListContainer.style.display = "none";
        DOMCache.devicesList.innerHTML = "";
        fetchOfficesAndDevices();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateNotificationCount() {
        let currentCount = parseInt(DOMCache.notificationCount.textContent);
        if (currentCount > 0) {
            DOMCache.notificationCount.textContent = currentCount - 1;
        }
    }
</script>
</body>
</html>